<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chess</title>
  <style>
  body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: darkblue;
    margin: 0;
    flex-direction: column;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(8, 70px);
    grid-template-rows: repeat(8, 70px);
    border: 4px solid blue;
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
  }
  .cell {
    width: 70px;
    height: 70px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 50px;
    font-family: "Segoe UI Symbol", "Noto Sans Symbols2", sans-serif;
    cursor: pointer;
    user-select: none;
  }
  .white { background: skyblue; }
  .black { background: lightblue; }
  .highlight { background: blue !important; }
</style>
</head>
<body>
  <div id="board"></div>
  < id="turn">Turn: White</>
  <script>
    const board=document.getElementById("board");
    const turnDisplay=document.getElementById("turn");

    const symbols={
      white:{king:"♔",queen:"♕",rook:"♖",bishop:"♗",knight:"♘",pawn:"♙"},
      black:{king:"♚",queen:"♛",rook:"♜",bishop:"♝",knight:"♞",pawn:"♟"}
    };

    let pieces={};
    let currentTurn="white";
    let selected=null;
    let validMoves=[];
    let enPassantTarget=null;
    let hasMoved={
      whiteKing:false,whiteRookA:false,whiteRookH:false,
      blackKing:false,blackRookA:false,blackRookH:false
    };

    function setupPieces(){
      pieces={
        "0-0":symbols.black.rook,"0-1":symbols.black.knight,"0-2":symbols.black.bishop,"0-3":symbols.black.queen,
        "0-4":symbols.black.king,"0-5":symbols.black.bishop,"0-6":symbols.black.knight,"0-7":symbols.black.rook,
        "1-0":symbols.black.pawn,"1-1":symbols.black.pawn,"1-2":symbols.black.pawn,"1-3":symbols.black.pawn,
        "1-4":symbols.black.pawn,"1-5":symbols.black.pawn,"1-6":symbols.black.pawn,"1-7":symbols.black.pawn,
        "6-0":symbols.white.pawn,"6-1":symbols.white.pawn,"6-2":symbols.white.pawn,"6-3":symbols.white.pawn,
        "6-4":symbols.white.pawn,"6-5":symbols.white.pawn,"6-6":symbols.white.pawn,"6-7":symbols.white.pawn,
        "7-0":symbols.white.rook,"7-1":symbols.white.knight,"7-2":symbols.white.bishop,"7-3":symbols.white.queen,
        "7-4":symbols.white.king,"7-5":symbols.white.bishop,"7-6":symbols.white.knight,"7-7":symbols.white.rook,
      };
    }

    function renderBoard(){
      board.innerHTML="";
      for(let r=0;r<8;r++){
        for(let c=0;c<8;c++){
          const cell=document.createElement("div");
          cell.className="cell "+((r+c)%2===0?"white":"black");
          cell.dataset.row=r; cell.dataset.col=c;
          let key=`${r}-${c}`;
          cell.textContent=pieces[key]||"";
          if(selected && validMoves.some(m=>m[0]===r&&m[1]===c)) cell.classList.add("highlight");
          cell.onclick=()=>cellClick(r,c);
          board.appendChild(cell);
        }
      }
    }

    function isWhitePiece(p){return Object.values(symbols.white).includes(p);}
    function isBlackPiece(p){return Object.values(symbols.black).includes(p);}
    function clonePieces(obj){return JSON.parse(JSON.stringify(obj));}

    function isKingInCheck(color,state){
      let kingPos=null;
      for(const [k,v] of Object.entries(state)){
        if(color==="white"&&v===symbols.white.king) kingPos=k;
        if(color==="black"&&v===symbols.black.king) kingPos=k;
      }
      if(!kingPos) return false;
      const [kr,kc]=kingPos.split("-").map(Number);
      for(const [k,v] of Object.entries(state)){
        if(color==="white"&&isBlackPiece(v)){
          if(getMovesFor(v,k,state,"black").some(([r,c])=>r===kr&&c===kc)) return true;
        }
        if(color==="black"&&isWhitePiece(v)){
          if(getMovesFor(v,k,state,"white").some(([r,c])=>r===kr&&c===kc)) return true;
        }
      }
      return false;
    }

    function getLegalMoves(piece,row,col){
      const moves=getMovesFor(piece,`${row}-${col}`,pieces,currentTurn);
      return moves.filter(([r,c])=>{
        let copy=clonePieces(pieces);
        let from=`${row}-${col}`,to=`${r}-${c}`;
        copy[to]=copy[from]; delete copy[from];
        if(piece===symbols.white.pawn && enPassantTarget===to) delete copy[`${row-1}-${c}`];
        if(piece===symbols.black.pawn && enPassantTarget===to) delete copy[`${row+1}-${c}`];
        return !isKingInCheck(currentTurn,copy);
      });
    }

    function getMovesFor(piece,key,state,color){
      let [row,col]=key.split("-").map(Number),moves=[];
      let isWhite=color==="white";
      if(piece===symbols.white.pawn||piece===symbols.black.pawn){
        let dir=isWhite?-1:1,start=isWhite?6:1;
        if(!state[`${row+dir}-${col}`]) moves.push([row+dir,col]);
        if(row===start&&!state[`${row+dir}-${col}`]&&!state[`${row+2*dir}-${col}`]) moves.push([row+2*dir,col]);
        [[dir,-1],[dir,1]].forEach(([dr,dc])=>{
          let tr=row+dr,tc=col+dc;
          let target=state[`${tr}-${tc}`];
          if(target&&((isWhite&&isBlackPiece(target))||(!isWhite&&isWhitePiece(target)))) moves.push([tr,tc]);
          if(`${tr}-${tc}`===enPassantTarget) moves.push([tr,tc]);
        });
      }
      if(piece===symbols.white.rook||piece===symbols.black.rook) lineMoves([[1,0],[-1,0],[0,1],[0,-1]]);
      if(piece===symbols.white.bishop||piece===symbols.black.bishop) lineMoves([[1,1],[1,-1],[-1,1],[-1,-1]]);
      if(piece===symbols.white.queen||piece===symbols.black.queen) lineMoves([[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]);
      if(piece===symbols.white.knight||piece===symbols.black.knight){
        [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc])=>{
          let r=row+dr,c=col+dc;
          if(r>=0&&r<8&&c>=0&&c<8){
            let t=state[`${r}-${c}`];
            if(!t||(isWhite&&isBlackPiece(t))||(!isWhite&&isWhitePiece(t))) moves.push([r,c]);
          }
        });
      }
      if(piece===symbols.white.king||piece===symbols.black.king){
        [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc])=>{
          let r=row+dr,c=col+dc;
          if(r>=0&&r<8&&c>=0&&c<8){
            let t=state[`${r}-${c}`];
            if(!t||(isWhite&&isBlackPiece(t))||(!isWhite&&isWhitePiece(t))) moves.push([r,c]);
          }
        });
        // Castling is already here...
      }
      function lineMoves(dirs){dirs.forEach(([dr,dc])=>{let r=row+dr,c=col+dc;while(r>=0&&r<8&&c>=0&&c<8){let t=state[`${r}-${c}`];if(!t)moves.push([r,c]);else{if((isWhite&&isBlackPiece(t))||(!isWhite&&isWhitePiece(t)))moves.push([r,c]);break;}r+=dr;c+=dc;}});}
      return moves;
    }

    function promotePawn(r,c,piece){
      if(piece===symbols.white.pawn && r===0) pieces[`${r}-${c}`]=symbols.white.queen;
      if(piece===symbols.black.pawn && r===7) pieces[`${r}-${c}`]=symbols.black.queen;
    }

    function cellClick(r,c){
      let key=`${r}-${c}`;
      if(selected){
        if(validMoves.some(([mr,mc])=>mr===r&&mc===c)){
          let from=`${selected[0]}-${selected[1]}`;
          let piece=pieces[from];
          if(piece===symbols.white.pawn&&enPassantTarget===key) delete pieces[`${r+1}-${c}`];
          if(piece===symbols.black.pawn&&enPassantTarget===key) delete pieces[`${r-1}-${c}`];
          pieces[key]=piece; delete pieces[from];
          // Pawn promotion
          promotePawn(r,c,piece);
          // Castling rook move
          if(piece===symbols.white.king){
            if(from==="7-4"&&key==="7-6"){pieces["7-5"]=symbols.white.rook;delete pieces["7-7"];}
            if(from==="7-4"&&key==="7-2"){pieces["7-3"]=symbols.white.rook;delete pieces["7-0"];}
            hasMoved.whiteKing=true;
          }
          if(piece===symbols.black.king){
            if(from==="0-4"&&key==="0-6"){pieces["0-5"]=symbols.black.rook;delete pieces["0-7"];}
            if(from==="0-4"&&key==="0-2"){pieces["0-3"]=symbols.black.rook;delete pieces["0-0"];}
            hasMoved.blackKing=true;
          }
          if(piece===symbols.white.rook){if(from==="7-0")hasMoved.whiteRookA=true;if(from==="7-7")hasMoved.whiteRookH=true;}
          if(piece===symbols.black.rook){if(from==="0-0")hasMoved.blackRookA=true;if(from==="0-7")hasMoved.blackRookH=true;}
          enPassantTarget=null;
          if(piece===symbols.white.pawn&&from.startsWith("6")&&r===4) enPassantTarget=`5-${c}`;
          if(piece===symbols.black.pawn&&from.startsWith("1")&&r===3) enPassantTarget=`2-${c}`;
          currentTurn=currentTurn==="white"?"black":"white";
          turnDisplay.textContent="Turn: "+currentTurn[0].toUpperCase()+currentTurn.slice(1);
        }
        selected=null; validMoves=[];
      } else {
        let piece=pieces[key];
        if(piece&&((currentTurn==="white"&&isWhitePiece(piece))||(currentTurn==="black"&&isBlackPiece(piece)))){
          selected=[r,c];
          validMoves=getLegalMoves(piece,r,c);
        }
      }
      renderBoard();
    }

    setupPieces(); renderBoard();
  </script>
</body>
</html>
